<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>2人対戦麻雀（仮）</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin-top: 50px;
    }

    #status {
      font-size: 1.5em;
      margin-bottom: 20px;
    }

    img {
      width: 40px;
      margin: 2px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div id="status">サーバーに接続中...</div>
  <div id="game" style="display: none;">
    <h2>対戦スタート！</h2>
    <p>あなたは <span id="player"></span> プレイヤーです。</p>
    <p>ルームID: <span id="room"></span></p>
  </div>

  <script>
    const statusDiv = document.getElementById('status');
    const gameDiv = document.getElementById('game');
    const playerSpan = document.getElementById('player');
    const roomSpan = document.getElementById('room');

    let myPlayerIndex = null;
    let myRoomId = null;
    let currentHand = [];
    let canDiscard = false;

    const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(`${protocol}://${location.host}/ws`);

    ws.onopen = () => {
      statusDiv.textContent = '待機中… 他のプレイヤーを待っています。';
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (data.type === 'start') {
        statusDiv.style.display = 'none';
        gameDiv.style.display = 'block';
        playerSpan.textContent = data.playerIndex === 0 ? '先手' : '後手';
        roomSpan.textContent = data.roomId;
        myPlayerIndex = data.playerIndex;
        myRoomId = data.roomId;

        if (data.hand) {
          currentHand = data.hand.slice().sort((a, b) => a - b);
          renderHand();
        }
      }

      if (data.type === 'tsumo') {
        currentHand.push(data.pai);
        currentHand.sort((a, b) => a - b);
        canDiscard = true;
        renderHand();

        const tsumoLog = document.createElement('p');
        tsumoLog.textContent = `あなたは牌 ${data.pai} をツモりました。`;
        gameDiv.appendChild(tsumoLog);
      }

      if (data.type === 'dahai') {
        const log = document.createElement('p');
        log.textContent = `プレイヤー${data.playerIndex + 1} が ${data.pai} を捨てました`;
        gameDiv.appendChild(log);
      }

      if (data.type === 'waiting') {
        statusDiv.textContent = `待機中… 現在 ${data.count} 人が待機しています。`;
      }
    };

    ws.onclose = () => {
      statusDiv.textContent = 'サーバーとの接続が切断されました。';
    };

    function renderHand() {
      const oldDisplay = document.getElementById('hand-display');
      if (oldDisplay) oldDisplay.remove();

      const handDisplay = document.createElement('div');
      handDisplay.id = 'hand-display';
      handDisplay.textContent = 'あなたの手牌: ';

      currentHand.forEach(pai => {
        const img = document.createElement('img');
        img.src = `/dist/image/${getTileImage(pai)}`;
        img.alt = pai;

        img.onclick = () => {
          if (!canDiscard) return; // ← 打牌不可なら無視

          canDiscard = false; // ← 打牌したら不可にする
          currentHand = currentHand.filter(p => p !== pai);
          renderHand();

          ws.send(JSON.stringify({
            type: 'dahai',
            roomId: myRoomId,
            playerIndex: myPlayerIndex,
            pai
          }));

          const log = document.createElement('p');
          log.textContent = `あなたは ${pai} を捨てました。`;
          gameDiv.appendChild(log);
        };
        
        handDisplay.appendChild(img);
      });

      gameDiv.appendChild(handDisplay);
    }

    function getTileImage(paiNumber) {
      const typeIndex = Math.floor(paiNumber / 4);
      if (typeIndex < 9) return `m${typeIndex + 1}.gif`;      // 萬子
      if (typeIndex < 18) return `p${typeIndex - 9 + 1}.gif`;  // 筒子
      if (typeIndex < 27) return `s${typeIndex - 18 + 1}.gif`; // 索子
      return `z${typeIndex - 27 + 1}.gif`;                     // 字牌
    }
  </script>
</body>

</html>